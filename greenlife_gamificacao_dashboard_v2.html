<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Greenlife ‚Äì Gamifica√ß√£o (Ranking)</title>
<style>
  :root{--bg:#0b1217;--card:#111827;--line:#1f2937;--ink:#e5e7eb;--muted:#9ca3af;--accent:#60a5fa}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;margin:24px;background:var(--bg);color:var(--ink)}
  h1{margin:0 0 16px 0;font-size:28px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.18);margin-bottom:12px}
  label{font-size:12px;color:var(--muted)}
  input,select{width:100%;padding:10px;border-radius:10px;border:1px dashed #334155;background:#0f172a;color:var(--ink)}
  button{padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#0f172a;color:var(--ink);cursor:pointer}
  button:hover{filter:brightness(1.15)}
  .row{display:grid;grid-template-columns:1.2fr .8fr;gap:12px}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
  th{background:#0f172a;position:sticky;top:0}
  .badge{padding:4px 10px;border-radius:999px;border:1px solid #334155;background:#0f172a;font-size:12px;margin-right:6px}
  .muted{color:var(--muted);font-size:12px}
  .kpis{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  .top3>div{margin-bottom:6px}
  canvas{width:100%;height:340px;border:1px solid var(--line);border-radius:12px;background:#0f172a}
</style>
</head>
<body>
  <h1>üèÜ Greenlife ‚Äì Gamifica√ß√£o (Ranking)</h1>

  <div class="row">
    <div class="card">
      <label>Link CSV (Google Sheets publicado na Web)</label>
      <input id="csvUrl" placeholder="cole aqui o link CSV da aba Export_SEMANAL_CSV ou Export_MENSAL_CSV">
      <div style="display:flex;gap:8px;margin-top:8px">
        <select id="regionSel">
          <option value="">Todas as regi√µes</option>
          <option>Regi√£o 1</option>
          <option>Regi√£o 2</option>
          <option>Regi√£o 3</option>
        </select>
        <button id="save">Salvar</button>
        <button id="load">Carregar</button>
      </div>
      <div class="muted" style="margin-top:6px">No Sheets: Arquivo ‚Üí Compartilhar ‚Üí Publicar na Web ‚Üí escolha a aba Export_*_CSV e formato CSV. Cole o link acima.</div>
      <div id="status" class="muted" style="margin-top:8px">Aguardando‚Ä¶</div>
    </div>
    <div class="card">
      <div class="kpis" id="kpis"></div>
      <div class="top3" id="top3"></div>
      <div class="muted" id="updated"></div>
    </div>
  </div>

  <div class="card">
    <h3>Ranking</h3>
    <table id="tbl"><thead><tr><th>#</th><th>Regi√£o</th><th>Unidade</th><th>Gerente</th><th>Total de Pontos</th></tr></thead><tbody></tbody></table>
  </div>

  <div class="card">
    <h3>Gr√°fico</h3>
    <canvas id="chart"></canvas>
  </div>

<script>
const EL = id=>document.getElementById(id);
const csvUrl=EL('csvUrl'), regionSel=EL('regionSel'), statusDiv=EL('status');
const kpis=EL('kpis'), top3=EL('top3'), tblBody=document.querySelector('#tbl tbody'), chart=EL('chart');

EL('save').addEventListener('click', ()=>{
  localStorage.setItem('gl_csv', csvUrl.value.trim());
  localStorage.setItem('gl_region', regionSel.value);
  status('Configura√ß√£o salva.');
});
EL('load').addEventListener('click', loadData);

(function init(){
  csvUrl.value = localStorage.getItem('gl_csv') || '';
  regionSel.value = localStorage.getItem('gl_region') || '';
})();

function status(m){ statusDiv.textContent = m; }

async function loadData(){
  try{
    const url = csvUrl.value.trim();
    if(!url){ status('Cole o link CSV publicado da aba Export_*_CSV.'); return; }
    status('Carregando‚Ä¶');
    const text = await (await fetch(url, {cache:'no-store'})).text();
    const data = parseCSV(text);
    const region = regionSel.value.trim();
    const filtered = region? data.filter(r=> (r['Regi√£o']||'').trim()===region) : data;
    render(filtered);
    status('Atualizado.');
    EL('updated').textContent = '√öltima atualiza√ß√£o: ' + new Date().toLocaleString();
  }catch(e){
    status('Falha ao carregar: ' + e.message);
  }
}

function parseCSV(t){
  const lines = t.trim().split(/\r?\n/);
  const headers = lines[0].split(',').map(h=>h.replace(/^"|"$/g,''));
  return lines.slice(1).filter(x=>x).map(line=>{
    const cells = splitCSV(line);
    const obj={}; headers.forEach((h,i)=> obj[h]=cells[i]?cells[i].replace(/^"|"$/g,''):'' );
    obj['Total de Pontos'] = Number((obj['Total de Pontos']||'0').replace(',','.'))||0;
    return obj;
  });
}
function splitCSV(line){
  const out=[]; let cur=''; let q=false;
  for(let i=0;i<line.length;i++){
    const c=line[i];
    if(c==='\"'){ if(q && line[i+1]==='\"'){ cur+='\"'; i++; } else { q=!q; } }
    else if(c===',' && !q){ out.push(cur); cur=''; }
    else { cur+=c; }
  }
  out.push(cur);
  return out;
}
function render(data){
  data.sort((a,b)=> Number(b['Total de Pontos']||0) - Number(a['Total de Pontos']||0));
  tblBody.innerHTML='';
  data.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${r['Regi√£o']||''}</td><td>${r['Unidade']||''}</td><td>${r['Gerente']||''}</td><td>${r['Total de Pontos']||0}</td>`;
    tblBody.appendChild(tr);
  });
  const total=data.reduce((s,r)=>s+(Number(r['Total de Pontos']||0)),0);
  const media=data.length?Math.round(total/data.length):0;
  const best=data[0]?.['Total de Pontos']||0;
  const worst=data[data.length-1]?.['Total de Pontos']||0;
  kpis.innerHTML=`<span class="badge">M√©dia: ${media} pts</span>
                  <span class="badge">Melhor: ${best} pts</span>
                  <span class="badge">Pior: ${worst} pts</span>
                  <span class="badge">Unidades: ${data.length}</span>`;
  top3.innerHTML = data.slice(0,3).map((r,i)=>`<div><span class="badge">${i+1}¬∫</span> <b>${r.Unidade||''}</b> ‚Äî ${r.Gerente||''} ¬∑ ${r['Total de Pontos']||0} pts <span class="badge">${r['Regi√£o']||''}</span></div>`).join('');
  drawBars(data.map(d=>d.Unidade||''), data.map(d=>Number(d['Total de Pontos']||0)));
}
function drawBars(labels, values){
  const ctx=chart.getContext('2d');
  const W=chart.clientWidth, H=chart.clientHeight, dpr=window.devicePixelRatio||1;
  chart.width=W*dpr; chart.height=H*dpr; ctx.scale(dpr,dpr); ctx.clearRect(0,0,W,H);
  const pad=40, innerW=W-pad*2, innerH=H-pad*2, max=Math.max(10,...values);
  ctx.strokeStyle='#334155'; ctx.beginPath(); ctx.moveTo(pad,pad); ctx.lineTo(pad,H-pad); ctx.lineTo(W-pad,H-pad); ctx.stroke();
  const gap=8, n=values.length||1, bw=(innerW-gap*(n-1))/n;
  values.forEach((v,i)=>{
    const h=v/max*(innerH-10), x=pad+i*(bw+gap), y=H-pad-h;
    ctx.fillStyle='#60a5fa'; ctx.fillRect(x,y,bw,h);
    ctx.fillStyle='#e5e7eb'; ctx.font='12px system-ui';
    const t=String(v); ctx.fillText(t, x+bw/2-ctx.measureText(t).width/2, y-4);
    const xl=labels[i]||''; ctx.fillText(xl, x+bw/2-ctx.measureText(xl).width/2, H-pad+14);
  });
}
</script>
</body>
</html>
