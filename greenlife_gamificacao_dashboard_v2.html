<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard de Ranking - Greenlife (Auto)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;margin:32px;background:#0b1217;color:#f1f5f9}
    h1{margin:0 0 16px 0;font-size:28px}
    .card{background:#111827;border:1px solid #1f2937;border-radius:16px;padding:20px;margin-bottom:16px;box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th, td{padding:10px 12px;border-bottom:1px solid #1f2937;text-align:left}
    th{position:sticky;top:0;background:#0f172a}
    .badge{padding:4px 10px;border-radius:999px;background:#1e293b;border:1px solid #334155;font-size:12px;margin-right:6px}
    .footer{opacity:.7;margin-top:12px;font-size:12px}
    input, select{background:#0f172a;border:1px dashed #334155;border-radius:10px;padding:10px;color:#f1f5f9;width:100%}
    label{font-size:12px;opacity:.9}
    button{padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#0f172a;color:#f1f5f9;cursor:pointer}
    button:hover{filter:brightness(1.2)}
    canvas{width:100%;height:360px;border-radius:12px;background:#0f172a;border:1px solid #1f2937}
    .stack{display:grid;gap:8px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  </style>
</head>
<body>
  <h1>üèÜ Dashboard de Ranking ‚Äì Greenlife (Auto)</h1>
  <div class="row">
    <div class="card stack">
      <h3>Conex√£o autom√°tica (Web API do Google Apps Script)</h3>
      <label>URL base do Web App</label>
      <input id="apiBase" type="url" placeholder="https://script.google.com/macros/s/AK.../exec">
      <div class="grid3">
        <div>
          <label>Aba (sheet)</label>
          <select id="apiSheet">
            <option>Export_SEMANAL_CSV</option>
            <option>Export_MENSAL_CSV</option>
          </select>
        </div>
        <div>
          <label>Regi√£o (opcional)</label>
          <select id="apiRegion">
            <option value="">Todas</option>
            <option>Regi√£o 1</option>
            <option>Regi√£o 2</option>
            <option>Regi√£o 3</option>
          </select>
        </div>
        <div>
          <label>Token (se definido no Apps Script)</label>
          <input id="apiToken" type="text" placeholder="ex.: MINHA_CHAVE_SECRETA">
        </div>
      </div>
      <div class="grid3">
        <div>
          <label>Auto-refresh (segundos)</label>
          <input id="refreshSec" type="number" min="5" step="5" value="60">
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="saveCfg">Salvar config</button>
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="loadNow">Carregar agora</button>
        </div>
      </div>
      <div class="footer">Dica: salve as configura√ß√µes. O dashboard atualiza sozinho a cada X segundos.</div>
    </div>
    <div class="card stack">
      <h3>Status</h3>
      <div id="status" class="footer">Aguardando configura√ß√£o‚Ä¶</div>
      <div id="metrics"></div>
    </div>
  </div>
  <div class="card">
    <h3>Top 3 ‚Äì Destaque</h3>
    <div id="top3"></div>
  </div>
  <div class="card">
    <h3>Ranking</h3>
    <table id="tbl"><thead><tr><th>#</th><th>Regi√£o</th><th>Unidade</th><th>Gerente</th><th>Total de Pontos</th></tr></thead><tbody></tbody></table>
  </div>
  <div class="card">
    <h3>Gr√°fico de Barras</h3>
    <canvas id="chart"></canvas>
  </div>
<script>
const EL = (id)=> document.getElementById(id);
const apiBase = EL("apiBase");
const apiSheet = EL("apiSheet");
const apiRegion = EL("apiRegion");
const apiToken = EL("apiToken");
const refreshSec = EL("refreshSec");
const saveCfg = EL("saveCfg");
const loadNow = EL("loadNow");
const statusDiv = EL("status");
const metricsDiv = EL("metrics");
const top3Div = EL("top3");
const tblBody = document.querySelector("#tbl tbody");
const chartCanvas = document.querySelector("#chart");

let timer = null;

saveCfg.addEventListener("click", ()=>{
  const cfg = {
    apiBase: apiBase.value.trim(),
    apiSheet: apiSheet.value.trim(),
    apiRegion: apiRegion.value.trim(),
    apiToken: apiToken.value.trim(),
    refreshSec: Math.max(5, Number(refreshSec.value||60))
  };
  localStorage.setItem("greenlife_cfg", JSON.stringify(cfg));
  status("Configura√ß√£o salva.");
  applyAutoRefresh(cfg);
});

loadNow.addEventListener("click", ()=>{
  const cfg = readCfg();
  fetchAndRender(cfg);
});

function readCfg(){
  try{
    const cfg = JSON.parse(localStorage.getItem("greenlife_cfg")||"{}");
    apiBase.value = cfg.apiBase||"";
    apiSheet.value = cfg.apiSheet||"Export_SEMANAL_CSV";
    apiRegion.value = cfg.apiRegion||"";
    apiToken.value = cfg.apiToken||"";
    refreshSec.value = cfg.refreshSec||60;
    return cfg;
  }catch(e){ return {}; }
}

function applyAutoRefresh(cfg){
  if(timer) clearInterval(timer);
  if(cfg.apiBase){
    timer = setInterval(()=> fetchAndRender(cfg), (cfg.refreshSec||60)*1000);
    fetchAndRender(cfg);
  }else{
    status("Informe a URL base do Web App.");
  }
}

async function fetchAndRender(cfg){
  try{
    const url = new URL(cfg.apiBase);
    url.searchParams.set("sheet", cfg.apiSheet||"Export_SEMANAL_CSV");
    if(cfg.apiRegion) url.searchParams.set("region", cfg.apiRegion);
    if(cfg.apiToken) url.searchParams.set("token", cfg.apiToken);
    url.searchParams.set("format", "json");
    status("Carregando‚Ä¶ " + url.toString());
    const res = await fetch(url.toString(), {cache:"no-store"});
    const data = await res.json();
    if(Array.isArray(data)){
      render(data);
      status("Atualizado: " + new Date().toLocaleString());
    }else{
      status("Erro: " + JSON.stringify(data));
    }
  }catch(err){
    status("Falha ao carregar: " + err.message);
  }
}

function status(msg){ statusDiv.textContent = msg; }

function render(data){
  data.sort((a,b)=> (Number(b["Total de Pontos"]||0)) - (Number(a["Total de Pontos"]||0)));
  tblBody.innerHTML = "";
  data.forEach((r,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${i+1}</td><td>${r["Regi√£o"]||""}</td><td>${r.Unidade||""}</td><td>${r.Gerente||""}</td><td>${r["Total de Pontos"]||0}</td>`;
    tblBody.appendChild(tr);
  });
  top3Div.innerHTML = data.slice(0,3).map((r,i)=>`
    <div style="margin-bottom:8px">
      <span class="badge">${i+1}¬∫</span> <b>${r.Unidade||""}</b> ‚Äì ${r.Gerente||""} ¬∑ ${r["Total de Pontos"]||0} pts
      <span class="badge">${r["Regi√£o"]||""}</span>
    </div>`).join("");
  const total = data.reduce((s,r)=> s + (Number(r["Total de Pontos"]||0)), 0);
  const avg = data.length ? Math.round(total/data.length) : 0;
  const best = data[0]?.["Total de Pontos"]||0;
  const worst = data[data.length-1]?.["Total de Pontos"]||0;
  metricsDiv.innerHTML = `
    <span class="badge">M√©dia: ${avg} pts</span>
    <span class="badge">Melhor: ${best} pts</span>
    <span class="badge">Pior: ${worst} pts</span>
    <span class="badge">Unidades: ${data.length}</span>
  `;
  drawBarChart(data.map(d=> `${d.Unidade}`), data.map(d=>Number(d["Total de Pontos"]||0)));
}

function drawBarChart(labels, values){
  const ctx = chartCanvas.getContext("2d");
  ctx.clearRect(0,0,chartCanvas.width, chartCanvas.height);
  const W = chartCanvas.clientWidth;
  const H = chartCanvas.clientHeight;
  const dpr = window.devicePixelRatio || 1;
  chartCanvas.width = W * dpr; chartCanvas.height = H * dpr;
  ctx.scale(dpr,dpr);

  const padding = 40;
  const innerW = W - padding*2;
  const innerH = H - padding*2;
  const maxVal = Math.max(10, ...values);
  ctx.strokeStyle = "#334155";
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(padding, padding);
  ctx.lineTo(padding, H - padding);
  ctx.lineTo(W - padding, H - padding);
  ctx.stroke();
  const n = values.length || 1;
  const gap = 8;
  const barW = (innerW - gap*(n-1)) / n;
  ctx.fillStyle = "#93c5fd";
  values.forEach((v,i)=>{
    const h = v/maxVal * (innerH - 10);
    const x = padding + i*(barW+gap);
    const y = H - padding - h;
    ctx.fillRect(x, y, barW, h);
    ctx.fillStyle = "#e2e8f0";
    ctx.font = "12px system-ui";
    const txt = String(v);
    ctx.fillText(txt, x + barW/2 - ctx.measureText(txt).width/2, y - 4);
    const xl = labels[i] || "";
    const width = ctx.measureText(xl).width;
    ctx.fillText(xl, x + barW/2 - width/2, H - padding + 14);
    ctx.fillStyle = "#93c5fd";
  });
}

const cfg = readCfg();
applyAutoRefresh(cfg);
</script>
</body>
</html>

